# ╔══════════════════════════════════════════════════════════════════════╗
# ║  krabkrab Docker Compose — Quick-start deployment                   ║
# ╚══════════════════════════════════════════════════════════════════════╝

services:
  krabkrab:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        FEATURES: "default"
        PROFILE: "release"
    image: openkrab/krabkrab:latest
    container_name: krabkrab
    restart: unless-stopped

    ports:
      - "${KRABKRAB_PORT:-4120}:4120"

    volumes:
      # Persist configuration across container recreations
      - krab-config:/data/config
      # Persist memory/knowledge base
      - krab-memory:/data/memory
      # Persist logs
      - krab-logs:/data/logs
      # Persist plugins
      - krab-plugins:/data/plugins

    environment:
      - RUST_LOG=${RUST_LOG:-info}
      - KRABKRAB_GATEWAY_TOKEN=${KRABKRAB_GATEWAY_TOKEN:-}
      - KRABKRAB_GATEWAY_HOST=${KRABKRAB_GATEWAY_HOST:-0.0.0.0}
      - KRABKRAB_GATEWAY_PORT=4120
      # Provider API keys (optional)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      # Messaging connectors (optional)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - DISCORD_TOKEN=${DISCORD_TOKEN:-}
      - MATRIX_ACCESS_TOKEN=${MATRIX_ACCESS_TOKEN:-}

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4120/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 128M
          cpus: "0.25"

volumes:
  krab-config:
    driver: local
  krab-memory:
    driver: local
  krab-logs:
    driver: local
  krab-plugins:
    driver: local
