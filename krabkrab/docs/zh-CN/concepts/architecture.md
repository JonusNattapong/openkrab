---
read_when:
  - æ­£åœ¨å¼€å‘ Gateway ç½‘å…³åè®®ã€å®¢æˆ·ç«¯æˆ–ä¼ è¾“å±‚
summary: WebSocket Gateway ç½‘å…³æž¶æž„ã€ç»„ä»¶å’Œå®¢æˆ·ç«¯æµç¨‹
title: Gateway ç½‘å…³æž¶æž„
x-i18n:
  generated_at: "2026-02-03T07:45:55Z"
  model: claude-opus-4-5
  provider: pi
  source_hash: c636d5d8a5e628067432b30671466309e3d630b106d413f1708765bf2a9399a1
  source_path: concepts/architecture.md
  workflow: 15
---

# Gateway ç½‘å…³æž¶æž„

æœ€åŽæ›´æ–°ï¼š2026-01-22

## æ¦‚è¿°

- å•ä¸ªé•¿æœŸè¿è¡Œçš„ **Gateway ç½‘å…³**æ‹¥æœ‰æ‰€æœ‰æ¶ˆæ¯å¹³å°ï¼ˆé€šè¿‡ Baileys çš„ WhatsAppã€é€šè¿‡ grammY çš„ Telegramã€Slackã€Discordã€Signalã€iMessageã€WebChatï¼‰ã€‚
- æŽ§åˆ¶å¹³é¢å®¢æˆ·ç«¯ï¼ˆmacOS åº”ç”¨ã€CLIã€Web ç•Œé¢ã€è‡ªåŠ¨åŒ–ï¼‰é€šè¿‡é…ç½®çš„ç»‘å®šä¸»æœºï¼ˆé»˜è®¤ `127.0.0.1:18789`ï¼‰ä¸Šçš„ **WebSocket** è¿žæŽ¥åˆ° Gateway ç½‘å…³ã€‚
- **èŠ‚ç‚¹**ï¼ˆmacOS/iOS/Android/æ— å¤´è®¾å¤‡ï¼‰ä¹Ÿé€šè¿‡ **WebSocket** è¿žæŽ¥ï¼Œä½†å£°æ˜Ž `role: node` å¹¶å¸¦æœ‰æ˜Žç¡®çš„èƒ½åŠ›/å‘½ä»¤ã€‚
- æ¯å°ä¸»æœºä¸€ä¸ª Gateway ç½‘å…³ï¼›å®ƒæ˜¯å”¯ä¸€æ‰“å¼€ WhatsApp ä¼šè¯çš„ä½ç½®ã€‚
- **canvas ä¸»æœº**ï¼ˆé»˜è®¤ `18793`ï¼‰æä¾›æ™ºèƒ½ä½“å¯ç¼–è¾‘çš„ HTML å’Œ A2UIã€‚

## ç»„ä»¶å’Œæµç¨‹

### Gateway ç½‘å…³ï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰

- ç»´æŠ¤æä¾›å•†è¿žæŽ¥ã€‚
- æš´éœ²ç±»åž‹åŒ–çš„ WS APIï¼ˆè¯·æ±‚ã€å“åº”ã€æœåŠ¡å™¨æŽ¨é€äº‹ä»¶ï¼‰ã€‚
- æ ¹æ® JSON Schema éªŒè¯å…¥ç«™å¸§ã€‚
- å‘å‡ºäº‹ä»¶å¦‚ `agent`ã€`chat`ã€`presence`ã€`health`ã€`heartbeat`ã€`cron`ã€‚

### å®¢æˆ·ç«¯ï¼ˆmac åº”ç”¨ / CLI / web ç®¡ç†ï¼‰

- æ¯ä¸ªå®¢æˆ·ç«¯ä¸€ä¸ª WS è¿žæŽ¥ã€‚
- å‘é€è¯·æ±‚ï¼ˆ`health`ã€`status`ã€`send`ã€`agent`ã€`system-presence`ï¼‰ã€‚
- è®¢é˜…äº‹ä»¶ï¼ˆ`tick`ã€`agent`ã€`presence`ã€`shutdown`ï¼‰ã€‚

### èŠ‚ç‚¹ï¼ˆmacOS / iOS / Android / æ— å¤´è®¾å¤‡ï¼‰

- ä»¥ `role: node` è¿žæŽ¥åˆ°**åŒä¸€ä¸ª WS æœåŠ¡å™¨**ã€‚
- åœ¨ `connect` ä¸­æä¾›è®¾å¤‡èº«ä»½ï¼›é…å¯¹æ˜¯**åŸºäºŽè®¾å¤‡**çš„ï¼ˆè§’è‰²ä¸º `node`ï¼‰ï¼Œæ‰¹å‡†å­˜å‚¨åœ¨è®¾å¤‡é…å¯¹å­˜å‚¨ä¸­ã€‚
- æš´éœ²å‘½ä»¤å¦‚ `canvas.*`ã€`camera.*`ã€`screen.record`ã€`location.get`ã€‚

åè®®è¯¦æƒ…ï¼š

- [Gateway ç½‘å…³åè®®](/gateway/protocol)

### WebChat

- é™æ€ç•Œé¢ï¼Œä½¿ç”¨ Gateway ç½‘å…³ WS API èŽ·å–èŠå¤©åŽ†å²å’Œå‘é€æ¶ˆæ¯ã€‚
- åœ¨è¿œç¨‹è®¾ç½®ä¸­ï¼Œé€šè¿‡ä¸Žå…¶ä»–å®¢æˆ·ç«¯ç›¸åŒçš„ SSH/Tailscale éš§é“è¿žæŽ¥ã€‚

## è¿žæŽ¥ç”Ÿå‘½å‘¨æœŸï¼ˆå•ä¸ªå®¢æˆ·ç«¯ï¼‰

```
Client                    Gateway
  |                          |
  |---- req:connect -------->|
  |<------ res (ok) ---------|   (or res error + close)
  |   (payload=hello-ok carries snapshot: presence + health)
  |                          |
  |<------ event:presence ---|
  |<------ event:tick -------|
  |                          |
  |------- req:agent ------->|
  |<------ res:agent --------|   (ack: {runId,status:"accepted"})
  |<------ event:agent ------|   (streaming)
  |<------ res:agent --------|   (final: {runId,status,summary})
  |                          |
```

## çº¿è·¯åè®®ï¼ˆæ‘˜è¦ï¼‰

- ä¼ è¾“ï¼šWebSocketï¼Œå¸¦ JSON è½½è·çš„æ–‡æœ¬å¸§ã€‚
- ç¬¬ä¸€å¸§**å¿…é¡»**æ˜¯ `connect`ã€‚
- æ¡æ‰‹åŽï¼š
  - è¯·æ±‚ï¼š`{type:"req", id, method, params}` â†’ `{type:"res", id, ok, payload|error}`
  - äº‹ä»¶ï¼š`{type:"event", event, payload, seq?, stateVersion?}`
- å¦‚æžœè®¾ç½®äº† `krabkrab_GATEWAY_TOKEN`ï¼ˆæˆ– `--token`ï¼‰ï¼Œ`connect.params.auth.token` å¿…é¡»åŒ¹é…ï¼Œå¦åˆ™å¥—æŽ¥å­—å…³é—­ã€‚
- æœ‰å‰¯ä½œç”¨çš„æ–¹æ³•ï¼ˆ`send`ã€`agent`ï¼‰éœ€è¦å¹‚ç­‰é”®ä»¥å®‰å…¨é‡è¯•ï¼›æœåŠ¡å™¨ä¿æŒçŸ­æœŸåŽ»é‡ç¼“å­˜ã€‚
- èŠ‚ç‚¹å¿…é¡»åœ¨ `connect` ä¸­åŒ…å« `role: "node"` ä»¥åŠèƒ½åŠ›/å‘½ä»¤/æƒé™ã€‚

## é…å¯¹ + æœ¬åœ°ä¿¡ä»»

- æ‰€æœ‰ WS å®¢æˆ·ç«¯ï¼ˆæ“ä½œå‘˜ + èŠ‚ç‚¹ï¼‰åœ¨ `connect` æ—¶åŒ…å«**è®¾å¤‡èº«ä»½**ã€‚
- æ–°è®¾å¤‡ ID éœ€è¦é…å¯¹æ‰¹å‡†ï¼›Gateway ç½‘å…³ä¸ºåŽç»­è¿žæŽ¥é¢å‘**è®¾å¤‡ä»¤ç‰Œ**ã€‚
- **æœ¬åœ°**è¿žæŽ¥ï¼ˆloopback æˆ– Gateway ç½‘å…³ä¸»æœºè‡ªèº«çš„ tailnet åœ°å€ï¼‰å¯ä»¥è‡ªåŠ¨æ‰¹å‡†ä»¥ä¿æŒåŒä¸»æœºç”¨æˆ·ä½“éªŒæµç•…ã€‚
- **éžæœ¬åœ°**è¿žæŽ¥å¿…é¡»ç­¾å `connect.challenge` nonce å¹¶éœ€è¦æ˜Žç¡®æ‰¹å‡†ã€‚
- Gateway ç½‘å…³è®¤è¯ï¼ˆ`gateway.auth.*`ï¼‰ä»é€‚ç”¨äºŽ**æ‰€æœ‰**è¿žæŽ¥ï¼Œæ— è®ºæœ¬åœ°è¿˜æ˜¯è¿œç¨‹ã€‚

è¯¦æƒ…ï¼š[Gateway ç½‘å…³åè®®](/gateway/protocol)ã€[é…å¯¹](/channels/pairing)ã€[å®‰å…¨](/gateway/security)ã€‚

## åè®®ç±»åž‹å’Œä»£ç ç”Ÿæˆ

- TypeBox æ¨¡å¼å®šä¹‰åè®®ã€‚
- ä»Žè¿™äº›æ¨¡å¼ç”Ÿæˆ JSON Schemaã€‚
- ä»Ž JSON Schema ç”Ÿæˆ Swift æ¨¡åž‹ã€‚

## è¿œç¨‹è®¿é—®

- æŽ¨èï¼šTailscale æˆ– VPNã€‚
- æ›¿ä»£æ–¹æ¡ˆï¼šSSH éš§é“
  ```bash
  ssh -N -L 18789:127.0.0.1:18789 user@host
  ```
- ç›¸åŒçš„æ¡æ‰‹ + è®¤è¯ä»¤ç‰Œé€‚ç”¨äºŽéš§é“è¿žæŽ¥ã€‚
- è¿œç¨‹è®¾ç½®ä¸­å¯ä»¥ä¸º WS å¯ç”¨ TLS + å¯é€‰çš„è¯ä¹¦å›ºå®šã€‚

## æ“ä½œå¿«ç…§

- å¯åŠ¨ï¼š`krabkrab gateway`ï¼ˆå‰å°ï¼Œæ—¥å¿—è¾“å‡ºåˆ° stdoutï¼‰ã€‚
- å¥åº·æ£€æŸ¥ï¼šé€šè¿‡ WS çš„ `health`ï¼ˆä¹ŸåŒ…å«åœ¨ `hello-ok` ä¸­ï¼‰ã€‚
- ç›‘æŽ§ï¼šä½¿ç”¨ launchd/systemd è‡ªåŠ¨é‡å¯ã€‚

## ä¸å˜é‡

- æ¯å°ä¸»æœºæ°å¥½ä¸€ä¸ª Gateway ç½‘å…³æŽ§åˆ¶å•ä¸ª Baileys ä¼šè¯ã€‚
- æ¡æ‰‹æ˜¯å¼ºåˆ¶çš„ï¼›ä»»ä½•éž JSON æˆ–éž connect çš„ç¬¬ä¸€å¸§éƒ½ä¼šå¯¼è‡´ç¡¬å…³é—­ã€‚
- äº‹ä»¶ä¸ä¼šé‡æ”¾ï¼›å®¢æˆ·ç«¯å¿…é¡»åœ¨å‡ºçŽ°é—´éš™æ—¶åˆ·æ–°ã€‚

